<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4CAF50">
  <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js");
  }
</script>
  <title>Presensi Mobile</title>
  <style>
    :root {
      --pri:#4CAF50; --pri2:#45a049; --bg:#f7f9fb;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body {
      font-family: "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh; padding:12px;
    }
    .card {
      max-width: 500px; margin: auto; background:#fff;
      border-radius:18px; box-shadow:0 6px 20px rgba(0,0,0,.2);
      overflow:hidden;
    }
    .header {
      padding:18px; color:#fff;
      background: linear-gradient(45deg,var(--pri),var(--pri2));
      text-align:center;
    }
    .header h1 { font-size:1.4rem; margin-bottom:4px }
    .header p { font-size:.9rem; opacity:.9 }

    .body { padding:18px }
    .row { display:grid; gap:12px; margin-bottom:14px }
    .row.two { grid-template-columns:1fr 1fr; gap:10px }

    label { font-size:.95rem; font-weight:600 }
    input, select {
      width:100%; padding:12px 14px; border:1.5px solid #ddd;
      border-radius:10px; font-size:1rem;
    }

    .section {
      background:#f8fafc; border:1px solid #eef2f7;
      padding:14px; border-radius:14px; margin-bottom:16px
    }
    .status {
      margin-top:10px; padding:10px;
      border-radius:10px; font-weight:500; text-align:center;
      font-size:.9rem
    }
    .ok{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .err{background:#fde2e1;color:#7a1c1b;border:1px solid #f5b5b2}
    .info{background:#e6f4ff;color:#084b7a;border:1px solid #c7e3ff}

    .button {
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px; padding:14px; border:none;
      border-radius:12px; font-weight:600; cursor:pointer;
      font-size:1rem; width:100%;
    }
    .primary{background:linear-gradient(45deg,var(--pri),var(--pri2));color:#fff}
    .secondary{background:linear-gradient(45deg,#2196F3,#1976D2);color:#fff}
    .button:disabled{opacity:.6;cursor:not-allowed}

    video {
      width:100%; border-radius:12px;
      background:#eef2f7; object-fit:cover; margin-bottom:10px;
    }
    #preview img {
      max-width:100%; border-radius:12px; border:3px solid var(--pri); margin-top:8px;
    }

    .kv {display:flex; justify-content:space-between; font-size:.9rem;
         border-bottom:1px dashed #e5e7eb; padding:6px 0 }
    .kv:last-child{border-bottom:none}
    a.map { font-size:.8rem; color:#1976D2; word-break:break-all }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <h1>üìã Daftar Hadir ASN Dinlutkan Kab. Rembang</h1>
      <p>Aplikasi ini dibuat dalam rangka optimalisasi kedisiplinan ASN di Lingkungan Dinlutkan</p>
    </div>
    <div class="body">
      <form id="formPresensi">
        <div class="row">
          <div>
            <label for="nama">Nama Lengkap</label>
            <input id="nama" name="nama" required />
          </div>
        </div>
        <div class="row two">
          <div>
            <label for="nip">NIP</label>
            <input id="nip" name="nip" required />
          </div>
          <div>
            <label for="status">Status</label>
            <select id="status" name="status" required>
              <option value="">Pilih</option>
              <option>Hadir</option><option>Terlambat</option><option>Izin</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="tpi">Unit Kerja</label>
            <select id="tpi" name="tpi" required>
              <option value="">Pilih Unit Kerja</option>
              <option>Dinas</option>
              <option>UPT</option>
              <option>TPI Tunggulsari</option>
              <option>TPI Tanjungsari</option>
              <option>TPI Tasikagung I</option>
              <option>TPI Tasikagung II</option>
              <option>TPI Pasarbanggi</option>
              <option>TPI Pandangan</option>
              <option>TPI Karanganyar</option>
              <option>TPI Karanglincak</option>
              <option>TPI Sarang</option>
              <option>WFH</option>
              <option>Lapangan</option>
            </select>
          </div>
        </div>

        <!-- Kamera -->
        <div class="section">
          <label>üì∑ Kamera</label>
          <video id="video" playsinline autoplay muted></video>
          <button type="button" id="btnKamera" class="button secondary">üé• Buka Kamera</button>
          <button type="button" id="btnFoto" class="button primary" disabled>üì∏ Ambil Foto</button>
          <button type="button" id="btnUlang" class="button" disabled>üîÑ Ulangi</button>
          <div id="preview"></div>
          <canvas id="canvas" style="display:none"></canvas>
          <div id="camMsg" class="status info" style="display:none"></div>
        </div>

        <!-- Lokasi -->
        <div class="section">
          <label>üìç Lokasi</label>
          <div class="kv"><span>Tanggal & Waktu</span><span id="waktu">-</span></div>
          <div class="kv"><span>Koordinat</span><span id="koor">Mencari...</span></div>
          <div class="kv"><span>Akurasi</span><span id="akurasi">-</span></div>
          <div class="kv"><span>Peta</span><a id="mapLink" class="map" target="_blank">-</a></div>
          <div id="locMsg" class="status info" style="display:none"></div>
        </div>

        <button id="btnSubmit" class="button primary" disabled>üíæ Simpan Presensi</button>
      </form>
      <div id="statusMsg"></div>
    </div>
  </div>

  <!-- Script sama persis dengan kode kamu, tinggal ditempel -->
   <script>
    // ====== Util waktu ======
    function updateWaktu() {
      const now = new Date();
      const opts = { weekday:'long', year:'numeric', month:'long', day:'numeric',
                     hour:'2-digit', minute:'2-digit', second:'2-digit', timeZone:'Asia/Jakarta' };
      document.getElementById('waktu').textContent = now.toLocaleDateString('id-ID', opts);
    }
    setInterval(updateWaktu, 1000); updateWaktu();

    // ====== State ======
    const state = { stream: null, photoDataUrl: null, lokasi: null, watchId: null };
    const el = (id) => document.getElementById(id);

    // ====== Kamera ======
    async function startCamera(preferBack = true) {
      showCamMsg("");
      el('btnFoto').disabled = true;
      el('btnUlang').disabled = true;
      const constraintsList = preferBack ? [
        { video: { facingMode: { exact: "user" } }, audio: false },
        { video: { facingMode: "user" }, audio: false },
        { video: true, audio: false }
      ] : [{ video: true, audio: false }];
      if (state.stream) {
        state.stream.getTracks().forEach(t => t.stop());
        state.stream = null;
      }
      for (const constraints of constraintsList) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          state.stream = stream;
          const video = el('video');
          video.srcObject = stream;
          await video.play();
          el('btnFoto').disabled = false;
          showCamMsg("Kamera aktif. Arahkan wajah/objek lalu klik Ambil Foto.", "ok");
          return;
        } catch {}
      }
      showCamMsg("Tidak dapat mengakses kamera. Pastikan situs HTTPS dan izin kamera sudah diberikan.", "err");
    }

    function showCamMsg(msg, type="info") {
      const box = el('camMsg');
      if (!msg) { box.style.display = "none"; box.textContent = ""; return; }
      box.className = "status " + (type==="ok"?"ok":type==="err"?"err":"info");
      box.textContent = msg; box.style.display = "block";
    }

    function ambilFoto() {
      const video = el('video');
      if (!video.videoWidth) { showCamMsg("Kamera belum siap, coba lagi sebentar.", "err"); return; }
      const canvas = el('canvas');
      const maxSide = 1280;
      const { videoWidth:w, videoHeight:h } = video;
      const scale = Math.min(1, maxSide / Math.max(w, h));
      canvas.width = Math.round(w * scale);
      canvas.height = Math.round(h * scale);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      state.photoDataUrl = canvas.toDataURL('image/jpeg', 0.85);
      el('preview').innerHTML = `<p><strong>Foto berhasil diambil:</strong></p><img src="${state.photoDataUrl}" alt="Foto">`;
      if (state.stream) { state.stream.getTracks().forEach(t => t.stop()); state.stream = null; }
      el('btnUlang').disabled = false;
      showCamMsg("Foto ditangkap. Jika kurang pas, klik Ulangi.", "ok");
      evaluateSubmitReady();
    }

    function ulangFoto() {
      state.photoDataUrl = null;
      el('preview').innerHTML = "";
      startCamera(true);
      evaluateSubmitReady();
    }

    // ====== Lokasi ======
    function showLocMsg(msg, type="info") {
      const box = el('locMsg');
      if (!msg) { box.style.display = "none"; box.textContent = ""; return; }
      box.className = "status " + (type==="ok"?"ok":type==="err"?"err":"info");
      box.textContent = msg; box.style.display = "block";
    }

    function startHighAccuracyGPS() {
      if (!('geolocation' in navigator)) {
        showLocMsg("Perangkat tidak mendukung geolokasi.", "err"); return;
      }
      showLocMsg("Mencari sinyal GPS akurat... tetap di tempat terbuka.", "info");
      el('koor').textContent = "Mencari..."; el('akurasi').textContent = "-";
      el('mapLink').textContent = "-"; el('mapLink').removeAttribute('href');
      if (state.watchId) { navigator.geolocation.clearWatch(state.watchId); state.watchId = null; }
      state.watchId = navigator.geolocation.watchPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          state.lokasi = { latitude, longitude, accuracy };
          el('koor').textContent = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
          el('akurasi').textContent = `¬±${Math.round(accuracy)} m`;
          const gmap = `https://maps.google.com/?q=${latitude},${longitude}`;
          el('mapLink').textContent = gmap; el('mapLink').href = gmap;
          if (accuracy <= 20) {
            showLocMsg("‚úÖ Lokasi akurat. Kamu bisa submit.", "ok");
          } else {
            showLocMsg("‚è≥ Akurasi masih kurang (coba ke area terbuka).", "info");
          }
          evaluateSubmitReady();
        },
        (err) => { showLocMsg("Gagal memperoleh lokasi: " + err.message, "err"); evaluateSubmitReady(); },
        { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
      );
    }

    function evaluateSubmitReady() {
      const hasPhoto = !!state.photoDataUrl;
      const gpsOk = state.lokasi && state.lokasi.accuracy <= 20;
      el('btnSubmit').disabled = !(hasPhoto && gpsOk);
    }

    // ====== Submit ======
    function showStatus(msg, type="info") {
      const box = el('statusMsg');
      box.className = "status " + (type==="ok"?"ok":type==="err"?"err":"info");
      box.textContent = msg;
    }

    async function submitPresensi(e) {
      e.preventDefault();
      if (el('btnSubmit').disabled) return;
      const data = {
        nama: el('nama').value.trim(),
        nip: el('nip').value.trim(),
        tpi: el('tpi').value,
        status: el('status').value,
        tanggal: new Date().toLocaleDateString('id-ID', { timeZone:'Asia/Jakarta' }),
        waktu: new Date().toLocaleTimeString('id-ID', { timeZone:'Asia/Jakarta' }),
        latitude: state.lokasi?.latitude ?? null,
        longitude: state.lokasi?.longitude ?? null,
        accuracy: state.lokasi?.accuracy ?? null,
        foto: state.photoDataUrl
      };
      if (!data.nama || !data.nip || !data.tpi || !data.status) {
        showStatus("Lengkapi semua field wajib.", "err"); return;
      }
      showStatus("Menyimpan presensi...", "info");
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx5KWoK_oAlKWZGrtnQtywX-HX_uAOE4idLdfPryw9HNG2hI1pZQ0rvnCe56_4h8nw/exec";
      try {
        await fetch(SCRIPT_URL, {
          method: "POST", mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        showStatus("‚úÖ Presensi berhasil disimpan!", "ok");
        el('formPresensi').reset();
        el('preview').innerHTML = "";
        state.photoDataUrl = null;
        evaluateSubmitReady();
      } catch (err) {
        showStatus("‚ùå Gagal menyimpan: " + err.message, "err");
      }
    }

    // ====== Event Binding ======
    el('btnKamera').addEventListener('click', () => startCamera(true));
    el('btnFoto').addEventListener('click', ambilFoto);
    el('btnUlang').addEventListener('click', ulangFoto);
    el('formPresensi').addEventListener('submit', submitPresensi);
    document.addEventListener('DOMContentLoaded', () => startHighAccuracyGPS());
  </script>
</body>
</html>




