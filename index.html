<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">
  <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js");
  }
  </script>
  <title>Presensi Mobile</title>
  <style>
    :root {
      --pri:#4CAF50; --pri2:#45a049; --bg:#f7f9fb;
      --shadow-sm: 0 2px 8px rgba(0,0,0,.08);
      --shadow-md: 0 4px 16px rgba(0,0,0,.12);
      --shadow-lg: 0 8px 32px rgba(0,0,0,.16);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body {
      font-family: "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh; padding:16px;
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(circle at 20% 50%, rgba(255,255,255,.1) 0%, transparent 50%),
                  radial-gradient(circle at 80% 80%, rgba(255,255,255,.08) 0%, transparent 50%);
      pointer-events: none;
    }
    .card {
      max-width: 480px; margin: auto; background:#fff;
      border-radius:24px; box-shadow: var(--shadow-lg);
      overflow:hidden; position: relative;
      animation: slideUp .5s ease-out;
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .header {
      padding:28px 24px; color:#fff;
      background: linear-gradient(135deg,#4CAF50 0%,#45a049 50%, #388E3C 100%);
      text-align:center;
      position: relative;
      overflow: hidden;
    }
    .header::before {
      content: '';
      position: absolute;
      top: -50%; right: -50%;
      width: 200%; height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,.1) 0%, transparent 70%);
      animation: pulse 3s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: .5; }
      50% { transform: scale(1.1); opacity: .3; }
    }
    .header-icon {
      font-size: 3rem;
      margin-bottom: 8px;
      display: inline-block;
      animation: bounce 2s ease-in-out infinite;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }
    .header h1 { 
      font-size:1.5rem; 
      margin-bottom:8px;
      font-weight: 700;
      position: relative;
      text-shadow: 0 2px 8px rgba(0,0,0,.2);
    }
    .header p { 
      font-size:.88rem; 
      opacity:.92;
      line-height: 1.4;
      position: relative;
    }

    .body { padding:24px }
    .row { display:grid; gap:14px; margin-bottom:16px }
    .row.two { grid-template-columns:1fr 1fr; gap:12px }

    .input-group {
      position: relative;
      margin-bottom: 18px;
    }
    label { 
      font-size:.92rem; 
      font-weight:600;
      color: #334155;
      display: block;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    input, select {
      width:100%; padding:14px 16px; 
      border:2px solid #e2e8f0;
      border-radius:12px; font-size:1rem;
      transition: all .3s ease;
      background: #fff;
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--pri);
      box-shadow: 0 0 0 4px rgba(76,175,80,.1);
    }

    .section {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border:2px solid #e2e8f0;
      padding:20px; 
      border-radius:16px; 
      margin-bottom:18px;
      transition: all .3s ease;
    }
    .section:hover {
      box-shadow: var(--shadow-sm);
      border-color: #cbd5e1;
    }
    .section-title {
      font-size: 1.05rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .status {
      margin-top:12px; padding:12px 16px;
      border-radius:12px; font-weight:500;
      font-size:.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
      animation: fadeIn .3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-4px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .ok{background:#d1fae5;color:#065f46;border:2px solid #6ee7b7}
    .err{background:#fee2e2;color:#991b1b;border:2px solid #fca5a5}
    .info{background:#dbeafe;color:#1e40af;border:2px solid #93c5fd}

    .button {
      display:inline-flex; align-items:center; justify-content:center;
      gap:10px; padding:14px 20px; border:none;
      border-radius:12px; font-weight:600; cursor:pointer;
      font-size:1rem; width:100%;
      transition: all .3s ease;
      position: relative;
      overflow: hidden;
    }
    .button::before {
      content: '';
      position: absolute;
      top: 50%; left: 50%;
      width: 0; height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,.3);
      transform: translate(-50%, -50%);
      transition: width .5s, height .5s;
    }
    .button:active::before {
      width: 300px;
      height: 300px;
    }
    .primary{
      background:linear-gradient(135deg,#4CAF50 0%,#45a049 100%);
      color:#fff;
      box-shadow: 0 4px 12px rgba(76,175,80,.3);
    }
    .primary:hover:not(:disabled){
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76,175,80,.4);
    }
    .secondary{
      background:linear-gradient(135deg,#2196F3 0%,#1976D2 100%);
      color:#fff;
      box-shadow: 0 4px 12px rgba(33,150,243,.3);
    }
    .secondary:hover:not(:disabled){
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(33,150,243,.4);
    }
    .button-outline {
      background: #fff;
      color: #64748b;
      border: 2px solid #e2e8f0;
      box-shadow: var(--shadow-sm);
    }
    .button-outline:hover:not(:disabled) {
      border-color: #cbd5e1;
      background: #f8fafc;
    }
    .button:disabled{
      opacity:.5;
      cursor:not-allowed;
      transform: none !important;
    }
    .button-group {
      display: grid;
      gap: 10px;
      margin-top: 12px;
    }

    video {
      width:100%; 
      border-radius:14px;
      background:#f1f5f9; 
      object-fit:cover; 
      margin-bottom:12px;
      border: 2px solid #e2e8f0;
      box-shadow: var(--shadow-sm);
    }
    #preview img {
      max-width:100%; 
      border-radius:14px; 
      border:3px solid var(--pri); 
      margin-top:12px;
      box-shadow: var(--shadow-md);
    }

    .kv {
      display:flex; 
      justify-content:space-between; 
      font-size:.9rem;
      border-bottom:1px dashed #cbd5e1; 
      padding:10px 0;
      align-items: center;
    }
    .kv:last-child{border-bottom:none}
    .kv-label {
      color: #64748b;
      font-weight: 500;
    }
    .kv-value {
      color: #1e293b;
      font-weight: 600;
      text-align: right;
    }
    a.map { 
      font-size:.85rem; 
      color:#1976D2; 
      word-break:break-all;
      text-decoration: none;
      padding: 4px 8px;
      border-radius: 6px;
      transition: all .2s ease;
    }
    a.map:hover {
      background: #dbeafe;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 8px;
      font-size: .8rem;
      font-weight: 600;
      background: #e0f2fe;
      color: #0369a1;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <div class="header-icon">üìã</div>
      <h1>Daftar Hadir ASN</h1>
      <p>Dinlutkan Kabupaten Rembang</p>
    </div>
    <div class="body">
      <form id="formPresensi">
        <div class="row two">
          <div class="input-group">
            <label for="nip">üÜî NIP</label>
            <input id="nip" name="nip" placeholder="Masukkan NIP" required />
          </div>
          <div class="input-group">
            <label for="status">‚úÖ Status</label>
            <select id="status" name="status" required>
              <option value="">Pilih Status</option>
              <option>Hadir</option>
              <option>Terlambat</option>
              <option>Izin</option>
            </select>
          </div>
        </div>
        
        <div class="input-group">
          <label for="tpi">üè¢ Unit Kerja</label>
          <select id="tpi" name="tpi" required>
            <option value="">Pilih Unit Kerja</option>
            <option>Dinas</option>
            <option>UPT</option>
            <option>TPI Tunggulsari</option>
            <option>TPI Tanjungsari</option>
            <option>TPI Tasikagung I</option>
            <option>TPI Tasikagung II</option>
            <option>TPI Pasarbanggi</option>
            <option>TPI Pandangan</option>
            <option>TPI Karanganyar</option>
            <option>TPI Karanglincak</option>
            <option>TPI Sarang</option>
            <option>WFH</option>
            <option>Lapangan</option>
          </select>
        </div>

        <!-- Kamera -->
        <div class="section">
          <div class="section-title">üì∑ Ambil Foto Selfie</div>
          <video id="video" playsinline autoplay muted></video>
          <div class="button-group">
            <button type="button" id="btnKamera" class="button secondary">üé• Aktifkan Kamera</button>
            <button type="button" id="btnFoto" class="button primary" disabled>üì∏ Ambil Foto</button>
            <button type="button" id="btnUlang" class="button button-outline" disabled>üîÑ Ulangi Foto</button>
          </div>
          <div id="preview"></div>
          <canvas id="canvas" style="display:none"></canvas>
          <div id="camMsg" class="status info" style="display:none"></div>
        </div>

        <!-- Lokasi -->
        <div class="section">
          <div class="section-title">üìç Informasi Lokasi</div>
          <div class="kv">
            <span class="kv-label">üìÖ Tanggal & Waktu</span>
            <span class="kv-value" id="waktu">-</span>
          </div>
          <div class="kv">
            <span class="kv-label">üåç Koordinat</span>
            <span class="kv-value" id="koor">Mencari...</span>
          </div>
          <div class="kv">
            <span class="kv-label">üéØ Akurasi</span>
            <span class="kv-value" id="akurasi">-</span>
          </div>
          <div class="kv">
            <span class="kv-label">üó∫Ô∏è Peta</span>
            <a id="mapLink" class="map" target="_blank">-</a>
          </div>
          <div id="locMsg" class="status info" style="display:none"></div>
        </div>

        <button id="btnSubmit" class="button primary" disabled>üíæ Simpan Presensi</button>
      </form>
      <div id="statusMsg"></div>
    </div>
  </div>

  <script>
    // ====== Util waktu ======
    function updateWaktu() {
      const now = new Date();
      const opts = { weekday:'long', year:'numeric', month:'long', day:'numeric',
                     hour:'2-digit', minute:'2-digit', second:'2-digit', timeZone:'Asia/Jakarta' };
      document.getElementById('waktu').textContent = now.toLocaleDateString('id-ID', opts);
    }
    setInterval(updateWaktu, 1000); updateWaktu();

    // ====== State ======
    const state = { stream: null, photoDataUrl: null, lokasi: null, watchId: null };
    const el = (id) => document.getElementById(id);

    // ====== Kamera ======
    async function startCamera(preferBack = true) {
      showCamMsg("");
      el('btnFoto').disabled = true;
      el('btnUlang').disabled = true;
      const constraintsList = preferBack ? [
        { video: { facingMode: { exact: "user" } }, audio: false },
        { video: { facingMode: "user" }, audio: false },
        { video: true, audio: false }
      ] : [{ video: true, audio: false }];
      if (state.stream) {
        state.stream.getTracks().forEach(t => t.stop());
        state.stream = null;
      }
      for (const constraints of constraintsList) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          state.stream = stream;
          const video = el('video');
          video.srcObject = stream;
          await video.play();
          el('btnFoto').disabled = false;
          showCamMsg("‚úÖ Kamera aktif. Arahkan wajah lalu klik Ambil Foto.", "ok");
          return;
        } catch {}
      }
      showCamMsg("‚ùå Tidak dapat mengakses kamera. Pastikan izin kamera sudah diberikan.", "err");
    }

    function showCamMsg(msg, type="info") {
      const box = el('camMsg');
      if (!msg) { box.style.display = "none"; box.textContent = ""; return; }
      box.className = "status " + (type==="ok"?"ok":type==="err"?"err":"info");
      box.textContent = msg; box.style.display = "block";
    }

    function ambilFoto() {
      const video = el('video');
      if (!video.videoWidth) { showCamMsg("‚ö†Ô∏è Kamera belum siap, coba lagi sebentar.", "err"); return; }
      const canvas = el('canvas');
      const maxSide = 1280;
      const { videoWidth:w, videoHeight:h } = video;
      const scale = Math.min(1, maxSide / Math.max(w, h));
      canvas.width = Math.round(w * scale);
      canvas.height = Math.round(h * scale);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      state.photoDataUrl = canvas.toDataURL('image/jpeg', 0.85);
      el('preview').innerHTML = `<p style="margin-top:12px;color:#059669;font-weight:600;font-size:.9rem;">‚úÖ Foto berhasil diambil</p><img src="${state.photoDataUrl}" alt="Foto">`;
      if (state.stream) { state.stream.getTracks().forEach(t => t.stop()); state.stream = null; }
      el('btnUlang').disabled = false;
      showCamMsg("‚úÖ Foto ditangkap. Jika kurang pas, klik Ulangi Foto.", "ok");
      evaluateSubmitReady();
    }

    function ulangFoto() {
      state.photoDataUrl = null;
      el('preview').innerHTML = "";
      startCamera(true);
      evaluateSubmitReady();
    }

    // ====== Lokasi ======
    function showLocMsg(msg, type="info") {
      const box = el('locMsg');
      if (!msg) { box.style.display = "none"; box.textContent = ""; return; }
      box.className = "status " + (type==="ok"?"ok":type==="err"?"err":"info");
      box.textContent = msg; box.style.display = "block";
    }

    function startHighAccuracyGPS() {
      if (!('geolocation' in navigator)) {
        showLocMsg("‚ùå Perangkat tidak mendukung geolokasi.", "err"); return;
      }
      showLocMsg("üîç Mencari sinyal GPS akurat... tetap di tempat terbuka.", "info");
      el('koor').textContent = "Mencari..."; el('akurasi').textContent = "-";
      el('mapLink').textContent = "-"; el('mapLink').removeAttribute('href');
      if (state.watchId) { navigator.geolocation.clearWatch(state.watchId); state.watchId = null; }
      state.watchId = navigator.geolocation.watchPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          state.lokasi = { latitude, longitude, accuracy };
          el('koor').textContent = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
          el('akurasi').textContent = `¬±${Math.round(accuracy)} m`;
          const gmap = `https://maps.google.com/?q=${latitude},${longitude}`;
          el('mapLink').textContent = gmap; el('mapLink').href = gmap;
          if (accuracy <= 20) {
            showLocMsg("‚úÖ Lokasi akurat terdeteksi. Siap untuk submit!", "ok");
          } else {
            showLocMsg("‚è≥ Akurasi masih kurang optimal. Coba pindah ke area terbuka.", "info");
          }
          evaluateSubmitReady();
        },
        (err) => { showLocMsg("‚ùå Gagal memperoleh lokasi: " + err.message, "err"); evaluateSubmitReady(); },
        { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
      );
    }

    function evaluateSubmitReady() {
      const hasPhoto = !!state.photoDataUrl;
      const gpsOk = state.lokasi && state.lokasi.accuracy <= 20;
      el('btnSubmit').disabled = !(hasPhoto && gpsOk);
    }

    // ====== Submit ======
    function showStatus(msg, type="info") {
      const box = el('statusMsg');
      box.className = "status " + (type==="ok"?"ok":type==="err"?"err":"info");
      box.textContent = msg;
    }

    async function submitPresensi(e) {
      e.preventDefault();
      if (el('btnSubmit').disabled) return;
      const data = {
        nip: el('nip').value.trim(),
        tpi: el('tpi').value,
        status: el('status').value,
        tanggal: new Date().toLocaleDateString('id-ID', { timeZone:'Asia/Jakarta' }),
        waktu: new Date().toLocaleTimeString('id-ID', { timeZone:'Asia/Jakarta' }),
        latitude: state.lokasi?.latitude ?? null,
        longitude: state.lokasi?.longitude ?? null,
        accuracy: state.lokasi?.accuracy ?? null,
        foto: state.photoDataUrl
      };
      if (!data.nip || !data.tpi || !data.status) {
        showStatus("‚ö†Ô∏è Lengkapi semua field wajib.", "err"); return;
      }
      showStatus("‚è≥ Menyimpan presensi...", "info");
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx5KWoK_oAlKWZGrtnQtywX-HX_uAOE4idLdfPryw9HNG2hI1pZQ0rvnCe56_4h8nw/exec";
      try {
        await fetch(SCRIPT_URL, {
          method: "POST", mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        showStatus("‚úÖ Presensi berhasil disimpan!", "ok");
        el('formPresensi').reset();
        el('preview').innerHTML = "";
        state.photoDataUrl = null;
        evaluateSubmitReady();
      } catch (err) {
        showStatus("‚ùå Gagal menyimpan: " + err.message, "err");
      }
    }

    // ====== Event Binding ======
    el('btnKamera').addEventListener('click', () => startCamera(true));
    el('btnFoto').addEventListener('click', ambilFoto);
    el('btnUlang').addEventListener('click', ulangFoto);
    el('formPresensi').addEventListener('submit', submitPresensi);
    document.addEventListener('DOMContentLoaded', () => startHighAccuracyGPS());
  </script>
</body>
</html>
