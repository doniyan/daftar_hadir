<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>Presensi (Kamera + GPS Akurat)</title>
  <style>
    :root { --pri:#4CAF50; --pri2:#45a049; --bg:#f7f9fb; }
    *{box-sizing:border-box} body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);margin:0;padding:16px;min-height:100vh}
    .card{max-width:720px;margin:0 auto;background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.2);overflow:hidden}
    .header{padding:20px;color:#fff;background:linear-gradient(45deg,var(--pri),var(--pri2))}
    .header h1{margin:0 0 4px} .header p{margin:0;opacity:.9}
    .body{padding:20px}
    .row{display:grid;gap:14px;margin-bottom:14px}
    @media(min-width:640px){.row.two{grid-template-columns:1fr 1fr}}
    label{font-weight:600} input,select{width:100%;padding:12px;border:2px solid #e6e9ef;border-radius:10px;font-size:16px}
    .section{background:#f8fafc;border:1px solid #eef2f7;padding:14px;border-radius:12px}
    .status{margin-top:10px;padding:10px;border-radius:10px;font-weight:600;text-align:center}
    .ok{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .err{background:#fde2e1;color:#7a1c1b;border:1px solid #f5b5b2}
    .info{background:#e6f4ff;color:#084b7a;border:1px solid #c7e3ff}
    .button{display:inline-flex;align-items:center;gap:8px;padding:12px 18px;border:none;border-radius:999px;font-weight:700;cursor:pointer}
    .primary{background:linear-gradient(45deg,var(--pri),var(--pri2));color:#fff}
    .secondary{background:linear-gradient(45deg,#2196F3,#1976D2);color:#fff}
    .button:disabled{opacity:.6;cursor:not-allowed}
    video{width:100%;max-height:340px;border-radius:12px;background:#eef2f7;object-fit:cover}
    #preview img{max-width:220px;border-radius:12px;border:3px solid var(--pri)}
    .kv{display:flex;justify-content:space-between;border-bottom:1px dashed #e5e7eb;padding:8px 0}
    .kv:last-child{border-bottom:none}
    a.map{word-break:break-all;font-size:12px;color:#1976D2}
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <h1>üìã Presensi (Foto + GPS)</h1>
      <p>Optimized untuk HP: kamera belakang & geolokasi akurat</p>
    </div>
    <div class="body">
      <form id="formPresensi">
        <div class="row">
          <div>
            <label for="nama">Nama Lengkap</label>
            <input id="nama" name="nama" required />
          </div>
        </div>
        <div class="row two">
          <div>
            <label for="nip">NIP</label>
            <input id="nip" name="nip" required />
          </div>
          <div>
            <label for="status">Status</label>
            <select id="status" name="status" required>
              <option value="">Pilih Status</option>
              <option>Hadir</option><option>Terlambat</option><option>Izin</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="tpi">TPI</label>
            <select id="tpi" name="tpi" required>
              <option value="">Pilih TPI</option>
              <option>Kantor Pusat</option><option>Kantor Cabang Jakarta</option>
              <option>Kantor Cabang Bandung</option><option>Kantor Cabang Surabaya</option>
              <option>Kantor Cabang Medan</option><option>Kantor Cabang Makassar</option>
              <option>Kantor Cabang Semarang</option><option>Remote/WFH</option>
              <option>Lapangan</option><option>Client Site</option><option>Lainnya</option>
            </select>
          </div>
        </div>

        <!-- Kamera -->
        <div class="section">
          <label>üì∑ Kamera Presensi</label>
          <video id="video" playsinline autoplay muted></video>
          <div style="margin:10px 0">
            <button type="button" id="btnKamera" class="button secondary">Buka Kamera (Belakang)</button>
            <button type="button" id="btnFoto" class="button primary" disabled>Ambil Foto</button>
            <button type="button" id="btnUlang" class="button" disabled>Ulangi</button>
          </div>
          <div id="preview"></div>
          <canvas id="canvas" style="display:none"></canvas>
          <div id="camMsg" class="status info" style="display:none"></div>
        </div>

        <!-- Lokasi -->
        <div class="section">
          <label>üìç Lokasi (GPS)</label>
          <div class="kv"><span>Tanggal & Waktu</span><span id="waktu">-</span></div>
          <div class="kv"><span>Koordinat</span><span id="koor">Mencari...</span></div>
          <div class="kv"><span>Akurasi</span><span id="akurasi">-</span></div>
          <div class="kv"><span>Peta</span><span><a id="mapLink" class="map" target="_blank" rel="noreferrer">-</a></span></div>
          <div id="locMsg" class="status info" style="display:none"></div>
        </div>

        <button id="btnSubmit" class="button primary" style="width:100%;justify-content:center" disabled>
          üíæ Simpan Presensi
        </button>
      </form>
      <div id="statusMsg"></div>
    </div>
  </div>

  <script>
    // ====== Util waktu ======
    function updateWaktu() {
      const now = new Date();
      const opts = { weekday:'long', year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit', timeZone:'Asia/Jakarta' };
      document.getElementById('waktu').textContent = now.toLocaleDateString('id-ID', opts);
    }
    setInterval(updateWaktu, 1000); updateWaktu();

    // ====== App ======
    const state = {
      stream: null,
      photoDataUrl: null,
      lokasi: null,
      watchId: null
    };

    const el = (id) => document.getElementById(id);

    // ====== Kamera ======
    async function startCamera(preferBack = true) {
      showCamMsg("");
      el('btnFoto').disabled = true;
      el('btnUlang').disabled = true;

      // Upaya pakai kamera belakang (environment), fallback otomatis jika gagal
      const constraintsList = preferBack ? [
        { video: { facingMode: { exact: "environment" } }, audio: false },
        { video: { facingMode: "environment" }, audio: false },
        { video: true, audio: false }
      ] : [{ video: true, audio: false }];

      // Stop stream lama jika ada
      if (state.stream) {
        state.stream.getTracks().forEach(t => t.stop());
        state.stream = null;
      }

      for (const constraints of constraintsList) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          state.stream = stream;
          const video = el('video');
          video.srcObject = stream;
          await video.play();
          el('btnFoto').disabled = false;
          showCamMsg("Kamera aktif. Arahkan wajah/objek lalu klik Ambil Foto.", "ok");
          return;
        } catch (err) {
          // coba constraint berikutnya
        }
      }
      showCamMsg("Tidak dapat mengakses kamera. Pastikan situs HTTPS dan izin kamera sudah diberikan.", "err");
    }

    function showCamMsg(msg, type="info") {
      const box = el('camMsg');
      if (!msg) { box.style.display = "none"; box.textContent = ""; return; }
      box.className = "status " + (type==="ok"?"ok":type==="err"?"err":"info");
      box.textContent = msg; box.style.display = "block";
    }

    function ambilFoto() {
      const video = el('video');
      if (!video.videoWidth) { showCamMsg("Kamera belum siap, coba lagi sebentar.", "err"); return; }
      const canvas = el('canvas');
      // resize proporsional max 1280px agar file tidak terlalu besar
      const maxSide = 1280;
      const { videoWidth:w, videoHeight:h } = video;
      const scale = Math.min(1, maxSide / Math.max(w, h));
      canvas.width = Math.round(w * scale);
      canvas.height = Math.round(h * scale);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      // kompres ke JPEG kualitas 0.85
      state.photoDataUrl = canvas.toDataURL('image/jpeg', 0.85);
      el('preview').innerHTML = `<p><strong>Foto berhasil diambil:</strong></p><img src="${state.photoDataUrl}" alt="Foto">`;
      // Matikan kamera setelah foto (hemat baterai)
      if (state.stream) { state.stream.getTracks().forEach(t => t.stop()); state.stream = null; }
      el('btnUlang').disabled = false;
      showCamMsg("Foto ditangkap. Jika kurang pas, klik Ulangi.", "ok");
      // aktifkan submit bila GPS juga sudah akurat
      evaluateSubmitReady();
    }

    function ulangFoto() {
      state.photoDataUrl = null;
      el('preview').innerHTML = "";
      startCamera(true);
      evaluateSubmitReady();
    }

    // ====== Lokasi (GPS gating) ======
    function showLocMsg(msg, type="info") {
      const box = el('locMsg');
      if (!msg) { box.style.display = "none"; box.textContent = ""; return; }
      box.className = "status " + (type==="ok"?"ok":type==="err"?"err":"info");
      box.textContent = msg; box.style.display = "block";
    }

    function startHighAccuracyGPS() {
      if (!('geolocation' in navigator)) {
        showLocMsg("Perangkat tidak mendukung geolokasi.", "err");
        return;
      }
      showLocMsg("Mencari sinyal GPS akurat... tetap di tempat terbuka.", "info");
      el('koor').textContent = "Mencari...";
      el('akurasi').textContent = "-";
      el('mapLink').textContent = "-"; el('mapLink').removeAttribute('href');

      if (state.watchId) { navigator.geolocation.clearWatch(state.watchId); state.watchId = null; }

      state.watchId = navigator.geolocation.watchPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          state.lokasi = { latitude, longitude, accuracy };
          el('koor').textContent = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
          el('akurasi').textContent = `¬±${Math.round(accuracy)} m`;
          const gmap = `https://maps.google.com/?q=${latitude},${longitude}`;
          el('mapLink').textContent = gmap; el('mapLink').href = gmap;

          if (accuracy <= 20) {
            showLocMsg("‚úÖ Lokasi akurat. Kamu bisa submit.", "ok");
          } else {
            showLocMsg("‚è≥ Akurasi masih kurang (coba ke area terbuka).", "info");
          }
          evaluateSubmitReady();
        },
        (err) => {
          showLocMsg("Gagal memperoleh lokasi: " + err.message, "err");
          evaluateSubmitReady();
        },
        { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
      );
    }

    function evaluateSubmitReady() {
      const hasPhoto = !!state.photoDataUrl;
      const gpsOk = state.lokasi && state.lokasi.accuracy <= 20;
      el('btnSubmit').disabled = !(hasPhoto && gpsOk);
    }

    // ====== Submit ======
    function showStatus(msg, type="info") {
      const box = el('statusMsg');
      box.className = "status " + (type==="ok"?"ok":type==="err"?"err":"info");
      box.textContent = msg;
    }

    async function submitPresensi(e) {
      e.preventDefault();
      if (el('btnSubmit').disabled) return;

      const data = {
        nama: el('nama').value.trim(),
        nip: el('nip').value.trim(),
        tpi: el('tpi').value,
        status: el('status').value,
        tanggal: new Date().toLocaleDateString('id-ID', { timeZone:'Asia/Jakarta' }),
        waktu: new Date().toLocaleTimeString('id-ID', { timeZone:'Asia/Jakarta' }),
        latitude: state.lokasi?.latitude ?? null,
        longitude: state.lokasi?.longitude ?? null,
        accuracy: state.lokasi?.accuracy ?? null,
        foto: state.photoDataUrl
      };

      if (!data.nama || !data.nip || !data.tpi || !data.status) {
        showStatus("Lengkapi semua field wajib.", "err"); return;
      }

      showStatus("Menyimpan presensi...", "info");

      // GANTI dengan URL Apps Script milik kamu
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx5KWoK_oAlKWZGrtnQtywX-HX_uAOE4idLdfPryw9HNG2hI1pZQ0rvnCe56_4h8nw/exec";

      try {
        await fetch(SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        showStatus("‚úÖ Presensi berhasil disimpan!", "ok");
        // reset minimal
        el('formPresensi').reset();
        el('preview').innerHTML = "";
        state.photoDataUrl = null;
        evaluateSubmitReady();
        // lanjutkan pantau GPS
      } catch (err) {
        showStatus("‚ùå Gagal menyimpan: " + err.message, "err");
      }
    }

    // ====== Event binding ======
    el('btnKamera').addEventListener('click', () => startCamera(true));
    el('btnFoto').addEventListener('click', ambilFoto);
    el('btnUlang').addEventListener('click', ulangFoto);
    el('formPresensi').addEventListener('submit', submitPresensi);

    // Mulai otomatis: GPS tracking
    document.addEventListener('DOMContentLoaded', () => {
      startHighAccuracyGPS();
    });
  </script>
</body>
</html>
